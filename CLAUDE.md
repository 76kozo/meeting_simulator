# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 開発コマンド

- **サーバー起動**: `npm start` (`node server.js`を実行)
- **開発時**: `node server.js` でローカル開発 (ポート3000)
- **テストなし**: テストフレームワークは未設定 (`npm test`はエラーを返す)

## アーキテクチャ概要

これは**多機関連携会議シミュレーター**で、障害者の就労支援における多機関連携会議のAI生成シミュレーションを行うWebアプリケーションです。段階的進行とタイピングアニメーションにより、まるで実際の会議を見ているような臨場感ある体験を提供します。Gemini APIを使用して、各種関係者間の現実的な会議対話を生成します。

### 主要コンポーネント

**バックエンド (server.js)**:
- Express.jsサーバーとBasic認証 (admin/password)
- レート制限 (`/api/`ルートで15分間に50リクエスト)
- API セキュリティのためのリファラーチェック
- **段階別API**: `POST /api/generate-step` - ステップ別の短時間シミュレーション生成
- 従来API: `POST /api/generate-simulation` - 一括シミュレーション生成（レガシー）
- 環境変数: `GEMINI_API_KEY`, `ADMIN_PASSWORD`, `PORT`, `ALLOWED_ORIGIN`

**フロントエンド (public/ ディレクトリ)**:
- バニラ HTML/CSS/JavaScript (フレームワークなし)
- 会議パラメータのフォーム入力
- **段階的進行UI**: 6ステップの視覚的インジケーター
- **タイピングアニメーション**: リアルタイム文字表示機能
- **速度調整**: タイピング速度とスキップ機能
- **タイピングインジケーター**: 「○○さんが入力中」表示
- テストデータ読み込み機能 (`testdata.json`)
- 役割割り当てを含む参加者解析

### 主要機能

1. **段階的会議進行**: 6ステップの段階的シミュレーション
   - ステップ1: 開会・参加者紹介
   - ステップ2: 観察結果報告
   - ステップ3: 希望・意向確認
   - ステップ4: 各機関情報共有
   - ステップ5: 意見交換
   - ステップ6: 支援方針確認

2. **リアルタイムタイピング体験**: チャット風のアニメーション表示
   - 1文字ずつのタイピング表示（20-200文字/秒で調整可能）
   - 発言者別の「入力中」インジケーター
   - スキップ機能で即座に表示可能
   - 発言間の自然な間隔調整

3. **多役割会議シミュレーション**: 就労選択支援員、学校職員、相談支援専門員、事業所職員、保護者など様々な参加者役割をサポート

4. **AI生成対話**: Gemini 2.0 Flash APIを使用した現実的な会話生成

5. **タイムアウト問題解決**: 30秒/ステップの短時間処理で確実な動作

6. **セキュリティ**: Basic認証、レート制限、リファラーチェック

7. **デプロイ対応**: Vercelデプロイメント設定（リージョンとタイムアウト設定）

### API連携

- Google Gemini API (generativelanguage.googleapis.com) を使用
- **段階別プロンプト**: ステップごとに最適化された短いプロンプト
- **前のステップ情報の引き継ぎ**: 会議の連続性を保持
- 30秒タイムアウトでの高速レスポンス
- **セキュリティ強化**: APIキーはサーバーサイドでのみ管理、クライアントからは完全に隠蔽

### デプロイメント設定

- **Vercel**: `vercel.json`でNode.jsバックエンドと静的フロントエンドを設定
- **リージョン**: 日本向け最適化 (hnd1)
- **タイムアウト**: API処理のため58秒

## セキュリティ注意事項

- Basic認証ですべてのルートを保護
- APIキーはサーバーサイドのみで保存・管理（クライアントに送信しない）
- リファラーチェックで直接API アクセスを防止
- レート制限で悪用を防止
- すべてのAPI呼び出しはサーバー経由で処理

## 実装完了事項

### セキュリティ強化
- **危険なAPIキー公開エンドポイントを削除**: `/api/get-api-key`を完全削除
- **コード重複排除**: クライアント側のGemini API直接呼び出しを削除し、サーバー経由に統一
- **構文エラー修正**: `public/script.js`の構文エラーを修正
- **アーキテクチャ統一**: すべてのAPI処理をサーバーサイドで実行

### パフォーマンス改善
- **モデル更新**: Gemini 2.0 Flash（最新安定版）に更新してパフォーマンス向上
- **タイムアウト問題解決**: 段階的生成により45秒→30秒/ステップに短縮
- **レスポンス時間改善**: 大幅な待機時間短縮

### 新機能実装
- **段階的会議進行**: 6ステップの段階的シミュレーション
- **リアルタイムタイピングアニメーション**: チャット風の臨場感ある表示
- **視覚的ステップインジケーター**: 進行状況の可視化
- **タイピング速度調整**: ユーザー体験のカスタマイズ
- **スキップ機能**: 待機時間の短縮オプション
- **「入力中」インジケーター**: より自然な会話体験

### 技術的改善
- **新API エンドポイント**: `/api/generate-step`による段階別処理
- **ステップ別プロンプト最適化**: 各段階に特化した効率的なプロンプト
- **前ステップ情報引き継ぎ**: 会議の連続性と文脈保持
- **CSS アニメーション**: 豊富な視覚効果とトランジション

## 使用方法

### 基本的な会議シミュレーション流れ

1. **フォーム入力**: 対象者の基本情報、アセスメント結果、観察ポイント、参加者情報を入力
2. **「シミュレーション開始」**: 段階的進行UIが表示される
3. **「会議を開始」**: ステップ1（開会・参加者紹介）が始まる
4. **タイピング観賞**: リアルタイムで各参加者の発言が1文字ずつ表示される
5. **「次のステップへ」**: 各ステップ完了後に次の段階に進む
6. **全6ステップ完了**: 会議終了メッセージとともにシミュレーション完了

### タイピング機能の操作

- **速度調整**: スライダーで20-200文字/秒の範囲で調整可能
- **スキップ機能**: 「スキップ」ボタンで即座に全文表示
- **自動進行**: 各発言の間に自然な間隔（800ms）を自動挿入

### 段階的進行の詳細

各ステップは約4-9発言程度で構成され、30秒以内で確実に完了します：

1. **開会・紹介** (6-8発言): 各参加者の自己紹介
2. **観察報告** (4-6発言): 就労選択支援での観察結果
3. **希望確認** (5-7発言): 本人と保護者の意向確認
4. **情報共有** (6-9発言): 各機関からの情報提供
5. **意見交換** (5-8発言): 専門的見地からの議論
6. **方針確認** (4-6発言): 支援方針の決定と閉会