# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 開発コマンド

- **サーバー起動**: `npm start` (`node server.js`を実行)
- **開発時**: `node server.js` でローカル開発 (ポート3000)
- **テストなし**: テストフレームワークは未設定 (`npm test`はエラーを返す)

## アーキテクチャ概要

これは**多機関連携会議シミュレーター**で、障害者の就労支援における多機関連携会議のAI生成シミュレーションを行うWebアプリケーションです。Gemini APIを使用して、各種関係者間の現実的な会議対話を生成します。

### 主要コンポーネント

**バックエンド (server.js)**:
- Express.jsサーバーとBasic認証 (admin/password)
- レート制限 (`/api/`ルートで15分間に50リクエスト)
- API セキュリティのためのリファラーチェック
- メイン API エンドポイント: `POST /api/generate-simulation` - Gemini APIを使用した会議シミュレーション生成
- 環境変数: `GEMINI_API_KEY`, `ADMIN_PASSWORD`, `PORT`, `ALLOWED_ORIGIN`

**フロントエンド (public/ ディレクトリ)**:
- バニラ HTML/CSS/JavaScript (フレームワークなし)
- 会議パラメータのフォーム入力
- 生成された会議対話のリアルタイム表示
- テストデータ読み込み機能 (`testdata.json`)
- 役割割り当てを含む参加者解析

### 主要機能

1. **多役割会議シミュレーション**: 就労選択支援員、学校職員、相談支援専門員、事業所職員、保護者など様々な参加者役割をサポート
2. **構造化された会議進行**: 開会から支援方針確認まで7ステップの会議進行
3. **AI生成対話**: Gemini 2.0 Flash APIを使用した現実的な会話生成
4. **セキュリティ**: Basic認証、レート制限、リファラーチェック
5. **デプロイ対応**: Vercelデプロイメント設定（リージョンとタイムアウト設定）

### API連携

- Google Gemini API (generativelanguage.googleapis.com) を使用
- 役割説明と会議構造を含む詳細なプロンプト
- タイムアウトとAPIエラーのハンドリング
- **セキュリティ強化**: APIキーはサーバーサイドでのみ管理、クライアントからは完全に隠蔽

### デプロイメント設定

- **Vercel**: `vercel.json`でNode.jsバックエンドと静的フロントエンドを設定
- **リージョン**: 日本向け最適化 (hnd1)
- **タイムアウト**: API処理のため58秒

## セキュリティ注意事項

- Basic認証ですべてのルートを保護
- APIキーはサーバーサイドのみで保存・管理（クライアントに送信しない）
- リファラーチェックで直接API アクセスを防止
- レート制限で悪用を防止
- すべてのAPI呼び出しはサーバー経由で処理

## リファクタリング完了事項

- **セキュリティ強化**: 危険な`/api/get-api-key`エンドポイントを削除
- **コード重複排除**: クライアント側のGemini API直接呼び出しを削除し、サーバー経由に統一
- **構文エラー修正**: `public/script.js`の構文エラーを修正
- **アーキテクチャ統一**: すべてのAPI処理をサーバーサイドで実行
- **モデル更新**: Gemini 2.0 Flash（最新安定版）に更新してパフォーマンス向上