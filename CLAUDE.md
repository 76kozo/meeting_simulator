# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 開発コマンド

- **サーバー起動**: `npm start` (`node server.js`を実行)
- **開発時**: `node server.js` でローカル開発 (ポート3000)
- **テストなし**: テストフレームワークは未設定 (`npm test`はエラーを返す)

## アーキテクチャ概要

これは**多機関連携会議シミュレーター**で、障害者の就労支援における多機関連携会議のAI生成シミュレーションを行うWebアプリケーションです。段階的進行とタイピングアニメーションにより、まるで実際の会議を見ているような臨場感ある体験を提供します。Gemini 2.0 Flash APIを使用して、各種関係者間の現実的な会議対話を生成します。

### プロジェクト成熟度

🎉 **本プロジェクトは完成版です**
- 全主要機能が実装済み
- 教育現場での実用に適したプロダクションレベル
- セキュリティ対応済み
- 継続的な機能拡張が可能な安定基盤

### 主要コンポーネント

**バックエンド (server.js)**:
- Express.jsサーバーとBasic認証 (admin/password)
- レート制限 (`/api/`ルートで15分間に50リクエスト)
- API セキュリティのためのリファラーチェック
- **段階別API**: `POST /api/generate-step` - ステップ別の短時間シミュレーション生成
- 従来API: `POST /api/generate-simulation` - 一括シミュレーション生成（レガシー）
- 環境変数: `GEMINI_API_KEY`, `ADMIN_PASSWORD`, `PORT`, `ALLOWED_ORIGIN`

**フロントエンド (public/ ディレクトリ)**:
- バニラ HTML/CSS/JavaScript (フレームワークなし)
- 会議パラメータのフォーム入力
- **段階的進行UI**: 6ステップの視覚的インジケーター
- **タイピングアニメーション**: リアルタイム文字表示機能
- **速度調整**: タイピング速度とスキップ機能
- **タイピングインジケーター**: 「○○さんが入力中」表示
- **設定選択UI**: ケースタイプ、アセスメント、目標パスなどの選択機能
- **固定ケース機能**: 予め設定されたテストケースの読み込み
- テストデータ読み込み機能 (`testdata.json`)
- 役割割り当てを含む参加者解析

### 主要機能

1. **段階的会議進行**: 6ステップの段階的シミュレーション
   - ステップ1: 開会・参加者紹介
   - ステップ2: 観察結果報告
   - ステップ3: 希望・意向確認
   - ステップ4: 各機関情報共有
   - ステップ5: 意見交換
   - ステップ6: 支援方針確認

2. **リアルタイムタイピング体験**: チャット風のアニメーション表示
   - 1文字ずつのタイピング表示（20-200文字/秒で調整可能）
   - 発言者別の「入力中」インジケーター
   - スキップ機能で即座に表示可能
   - 発言間の自然な間隔調整

3. **多役割会議シミュレーション**: 就労選択支援員、学校職員、相談支援専門員、事業所職員、保護者など様々な参加者役割をサポート

4. **AI生成対話**: Gemini 2.0 Flash APIを使用した現実的な会話生成

5. **タイムアウト問題解決**: 30秒/ステップの短時間処理で確実な動作

6. **セキュリティ**: Basic認証、レート制限、リファラーチェック

7. **デプロイ対応**: Vercelデプロイメント設定（リージョンとタイムアウト設定）

8. **設定選択機能**: ケースタイプ、アセスメント手法、目標設定パターンなどの詳細設定

9. **AI要約・提案機能**: 会議内容の自動要約と次のステップ提案

10. **固定ケース**: よく使用される会議パターンの事前設定

## 完成済み機能一覧

### ✅ コア機能（完全実装済み）
- **段階的会議シミュレーション**: 6ステップの段階的進行システム
- **リアルタイムタイピング**: チャット風の1文字ずつアニメーション表示
- **AI対話生成**: Gemini 2.0 Flash による高品質な会議対話
- **設定カスタマイズ**: 詳細な会議設定（ケース、アセスメント、目標等）
- **AI要約・提案**: 各ステップ後の自動要約と次ステップ提案

### ✅ ユーザー体験（完全実装済み）
- **視覚的進行管理**: ステップインジケーターによる進捗可視化
- **速度制御**: タイピング速度調整（20-200文字/秒）とスキップ機能
- **直感的操作**: ワンクリックでの設定変更とシミュレーション開始
- **エラー対応**: 詳細なエラーメッセージとリトライ機能

### ✅ セキュリティ（完全実装済み）
- **Basic認証**: 全ルートの認証保護
- **APIキー保護**: サーバーサイドでの秘匿管理
- **レート制限**: 悪用防止（15分間50リクエスト）
- **リファラーチェック**: 直接API アクセス防止

### ✅ デプロイメント（完全実装済み）
- **Vercel対応**: プロダクション環境での安定動作
- **環境変数管理**: セキュアな設定管理
- **パフォーマンス最適化**: 30秒/ステップの高速処理

### API連携

- Google Gemini API (generativelanguage.googleapis.com) を使用
- **段階別プロンプト**: ステップごとに最適化された短いプロンプト
- **前のステップ情報の引き継ぎ**: 会議の連続性を保持
- 30秒タイムアウトでの高速レスポンス
- **セキュリティ強化**: APIキーはサーバーサイドでのみ管理、クライアントからは完全に隠蔽

### デプロイメント設定

- **Vercel**: `vercel.json`でNode.jsバックエンドと静的フロントエンドを設定
- **リージョン**: 日本向け最適化 (hnd1)
- **タイムアウト**: API処理のため58秒

## セキュリティ注意事項

- Basic認証ですべてのルートを保護
- APIキーはサーバーサイドのみで保存・管理（クライアントに送信しない）
- リファラーチェックで直接API アクセスを防止
- レート制限で悪用を防止
- すべてのAPI呼び出しはサーバー経由で処理

## 開発履歴・実装完了事項

### 🔒 セキュリティ強化（完了）
- ✅ **危険なAPIキー公開エンドポイントを削除**: `/api/get-api-key`を完全削除
- ✅ **コード重複排除**: クライアント側のGemini API直接呼び出しを削除し、サーバー経由に統一
- ✅ **構文エラー修正**: `public/script.js`の構文エラーを修正
- ✅ **アーキテクチャ統一**: すべてのAPI処理をサーバーサイドで実行

### ⚡ パフォーマンス改善（完了）
- ✅ **モデル更新**: Gemini 2.0 Flash（最新安定版）に更新してパフォーマンス向上
- ✅ **タイムアウト問題解決**: 段階的生成により45秒→30秒/ステップに短縮
- ✅ **レスポンス時間改善**: 大幅な待機時間短縮

### 🚀 新機能実装（完了）
- ✅ **段階的会議進行**: 6ステップの段階的シミュレーション
- ✅ **リアルタイムタイピングアニメーション**: チャット風の臨場感ある表示
- ✅ **視覚的ステップインジケーター**: 進行状況の可視化
- ✅ **タイピング速度調整**: ユーザー体験のカスタマイズ
- ✅ **スキップ機能**: 待機時間の短縮オプション
- ✅ **「入力中」インジケーター**: より自然な会話体験
- ✅ **設定選択UI**: ケースタイプ、アセスメント手法、目標パスなどの詳細設定
- ✅ **固定ケース機能**: 予め設定されたテストケースによる迅速なシミュレーション開始
- ✅ **AI要約・提案**: 会議終了時の自動要約と提案生成
- ✅ **エラーハンドリング強化**: ネットワークエラーやタイムアウトへの対応改善

### 🔧 技術的改善（完了）
- ✅ **新API エンドポイント**: `/api/generate-step`による段階別処理
- ✅ **ステップ別プロンプト最適化**: 各段階に特化した効率的なプロンプト
- ✅ **前ステップ情報引き継ぎ**: 会議の連続性と文脈保持
- ✅ **CSS アニメーション**: 豊富な視覚効果とトランジション
- ✅ **設定状態管理**: クライアントサイドでの設定値保持と管理
- ✅ **モジュラー設計**: 機能別に分離された構造

## 📊 プロジェクト成果

**達成された価値：**
- 🎯 **教育効果**: 臨場感ある会議体験による実践的学習
- 🛡️ **セキュリティ**: プロダクション環境対応の安全性
- 🚀 **ユーザビリティ**: 直感的操作と高速レスポンス
- 🔄 **拡張性**: 新機能追加が容易な設計基盤

## 使用方法

### 基本的な会議シミュレーション流れ

1. **設定選択**: ケースタイプ、アセスメント手法、目標パス等を詳細設定
2. **フォーム入力**: 対象者の基本情報、アセスメント結果、観察ポイント、参加者情報を入力
3. **「シミュレーション開始」**: 段階的進行UIが表示される
4. **「会議を開始」**: ステップ1（開会・参加者紹介）が始まる
5. **タイピング観賞**: リアルタイムで各参加者の発言が1文字ずつ表示される
6. **「次のステップへ」**: 各ステップ完了後に次の段階に進む
7. **全6ステップ完了**: AI要約・提案とともにシミュレーション完了

### 固定ケース利用の流れ

1. **「テストデータを読み込む」**: 予め設定されたケースを選択
2. **設定調整**: 必要に応じて読み込まれた設定を微調整
3. **上記3以降と同様**: 段階的進行でシミュレーション実行

### タイピング機能の操作

- **速度調整**: スライダーで20-200文字/秒の範囲で調整可能
- **スキップ機能**: 「スキップ」ボタンで即座に全文表示
- **自動進行**: 各発言の間に自然な間隔（800ms）を自動挿入

### 段階的進行の詳細

各ステップは約4-9発言程度で構成され、30秒以内で確実に完了します：

1. **開会・紹介** (6-8発言): 各参加者の自己紹介
2. **観察報告** (4-6発言): 就労選択支援での観察結果
3. **希望確認** (5-7発言): 本人と保護者の意向確認
4. **情報共有** (6-9発言): 各機関からの情報提供
5. **意見交換** (5-8発言): 専門的見地からの議論
6. **方針確認** (4-6発言): 支援方針の決定と閉会

### 設定オプション詳細

**ケースタイプ**:
- カスタム: ユーザー入力による独自ケース
- 標準ケース: 一般的な就労支援ケース
- 困難ケース: 複雑な課題を持つケース

**アセスメント手法**:
- 職業興味検査、作業能力評価、職場適応評価など

**目標設定パターン**:
- 合意形成重視、段階的目標設定、柔軟調整型など

**進行パターン**:
- 構造化進行、自然な流れ、議論中心型など

**専門性レベル**:
- バランス型、高度専門型、実践重視型など

## 🎯 今後の発展可能性

このプロジェクトは完成版ですが、さらなる拡張が可能です：

### 📈 機能拡張の方向性
- **ケーススタディ拡充**: より多様な障害類型・年齢層への対応
- **学習効果測定**: ユーザーの理解度・スキル向上の可視化
- **詳細分析機能**: 会議パターンの統計分析とレポート生成
- **多言語対応**: 国際的な活用への対応

### 🔗 連携可能性
- **Learning Management System (LMS)**: 教育機関との統合
- **業務システム**: 実際の支援記録システムとの連携
- **研究活用**: 支援技術研究のデータ収集基盤

### 💡 技術発展への対応
- **新AI モデル**: より高性能なAI モデルへの更新対応
- **音声対応**: 音声合成による会議体験の向上
- **VR/AR**: 没入型体験への発展可能性

**設計思想**: 現在の安定基盤を維持しながら、必要に応じて段階的に機能追加が可能